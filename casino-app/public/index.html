<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   
   <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
   
   <link rel="stylesheet" href="stylesheets/style.css">
   
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
   
   <!-- Latest compiled and minified CSS -->
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

   <!-- Optional theme -->
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
   
   <title>Casino Ethereum Dapp</title>
</head>
<body>
   <div id="root"></div>
    <div className="main-container" style="padding-left:20px">
                  <h1>Take your best bet and win huge amounts of ether!</h1>
               <div className="block">
                     <b>Number of bets:</b> &nbsp;
                     <span id="bet-count"></span>
                  </div>
      <div className="block">
                     <b>Last number winner:</b> &nbsp;
                     <span id="last-number-winner"></span>
                  </div>
      <div className="block">
                     <b>Total ether bet:</b> &nbsp;
                     <span id="total-bet-value"></span> &nbsp; ether
                  </div>
      <div className="block">
                     <b>Minimum bet:</b> &nbsp;
                     <span id="minimum-bet"></span> &nbsp; ether
                  </div>
      <div className="block">
                     <b>Max amount of bets:</b> &nbsp;
                     <span id="max-amount-bets"></span> &nbsp; bets
                  </div>
      <hr/>
      <h2>Vote for the next number</h2>
         <label>
            <b>How much Ether do you want to bet? <input id="bet-value" className="bet-input" ref="ether-bet" type="number"/></b> ether
            <br/>
         </label>
         <ul ref="numbers" id="num-list">
            <li value="1">1</li>
            <li value="2">2</li>
            <li value="3">3</li>
            <li value="4">4</li>
            <li value="5">5</li>
            <li value="6">6</li>
            <li value="7">7</li>
            <li value="8">8</li>
            <li value="9">9</li>
            <li value="10">10</li>
        </ul>
      <hr/>
      <button type="submit" id="generate-winner" class="btn btn-primary align-center" data-toggle="modal" data-target="#winner-modal">Generate Winner</button>
      <button type="submit" id="reset-bids" class="btn btn-danger align-center">Reset Bids</button>
   </div>
   <!-- Modal -->
   <div class="modal fade" id="winner-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
         <div class="modal-content">
            <div class="modal-header">
               <h5 class="modal-title" id="exampleModalLabel">Generating Winner</h5>
            </div>
            <div class="modal-body">
               Please wait while your transaction is mined and executed!
            </div>
            <div class="modal-footer">
               <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
         </div>
      </div>
   </div>
   <!--<script src="build.js"></script>-->
   <script>
      if (typeof web3 !== 'undefined') 
      {
      web3 = new Web3(web3.currentProvider);
      } 
      else 
      {
      // set the provider you want from Web3.providers
      web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
      }
      var MyContract = web3.eth.contract([
	{
		"constant": false,
		"inputs": [],
		"name": "generateNumberWinner",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "numberOfBets",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "player",
				"type": "address"
			}
		],
		"name": "checkPlayerExists",
		"outputs": [
			{
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "kill",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "resetData",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"name": "playerInfo",
		"outputs": [
			{
				"name": "amountBet",
				"type": "uint256"
			},
			{
				"name": "numberSelected",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "numberWinner",
				"type": "uint256"
			}
		],
		"name": "distributePrizes",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "numberSelected",
				"type": "uint256"
			}
		],
		"name": "bet",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "lastNumberWinner",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "minimumBet",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "maxAmountOfBets",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "players",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "totalBet",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"name": "_minimumBet",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"payable": true,
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "_number",
				"type": "uint256"
			}
		],
		"name": "Winner",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "_sender",
				"type": "address"
			}
		],
		"name": "BetPlaced",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "_resetStatus",
				"type": "bool"
			}
		],
		"name": "Reset",
		"type": "event"
	}
]);
   var CasinoInstance = MyContract.at('0x15b9ae748ef0650ab2d29cc24c9ff17fd108cbd4');

   refreshPageContent();

   var minimumBettingValue = 0;

   function refreshPageContent() {

      CasinoInstance.numberOfBets(function(err, result){
         $('#bet-count').text(result['c'][0]);
      });

      CasinoInstance.minimumBet(function(err, result){
         minimumBettingValue = result.toNumber()/Math.pow(10, 18);;
         $('#minimum-bet').text(minimumBettingValue);
      });

      CasinoInstance.totalBet(function(err, result){
         $('#total-bet-value').text(result.toNumber()/Math.pow(10, 18));
      });

      CasinoInstance.maxAmountOfBets(function(err, result){
         $('#max-amount-bets').text(result.toNumber());
      });

      CasinoInstance.lastNumberWinner(function(err, result){
         $('#last-number-winner').text(result.toNumber());
      });

   }

   //For triggering the vote
   document.getElementById("num-list").addEventListener("click",function(e) {
      console.log("button clicked");
      console.log(e.target.value);
      var vote = e.target.value;
      var ethers = $("#bet-value").val();
      console.log(ethers);

      CasinoInstance.bet(vote, {
               gas: 300000,
               from: web3.eth.accounts[0],
               value: web3.toWei(ethers, 'ether')
            }, (err, transactionHash) => {
               console.log("bet placed");
               console.log(transactionHash);
               refreshPageContent();
      });
   });

   $("#generate-winner").click(function(){
        CasinoInstance.generateNumberWinner(function(err, result){
            var event = CasinoInstance.Winner();

            // watch for changes
            event.watch(function(error, result){
               if (!error)
                  $('#winner-modal').modal('toggle');
                  refreshPageContent();
                  //$('#last-number-winner').text(result['args']['_number'].toNumber());
            });
         });
    }); 

    $("#reset-bids").click(function(){
        CasinoInstance.resetData(function(err, result){
           console.log(result);

           var resetEvent = CasinoInstance.Reset();

           resetEvent.watch(function(error, result) {
              alert('Reset Successful');
         });
      });
    });


</script>
</body>
</html>
